---
title: "Machine Learning Applied to Hepatocellular Carcinoma"
author: "Sangil Lee, Yujing Lu, Josh Tomiyama"
date: "`r Sys.Date()`"
output: 
  beamer_presentation:
    theme: "Darmstadt"
    colortheme: "crane"
    incremental: true
    slide_level: 2
bibliography: references.bib
nocite: '@*'
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
```
  
```{r loadPackages, echo = FALSE, message=FALSE, warning=FALSE}
suppressPackageStartupMessages(library(tidyr))
suppressPackageStartupMessages(library(knitr))
suppressPackageStartupMessages(library(dplyr))
suppressPackageStartupMessages(library(MachineShop))
suppressPackageStartupMessages(library(recipes))
suppressPackageStartupMessages(library(kableExtra))
suppressPackageStartupMessages(library(arsenal))
if(!dir.exists("./vi_cache/")){
  dir.create("./vi_cache/")
}
```  
  
# Background HCC

## HepatoCellular Carcinoma (HCC)

* HepatoCellular Carcinoma (HCC) 6th most frequently diagnosed cancer. 

* Data mining approach to tailor evaluation and treatment for HCC are limited in the literature.

* Using the HCC dataset, we undertook the data mining approach to evaluate the patient level factors to identify those who are at risk of one year mortality. 

## Dataset Summary

* HepatoCellular Carcinoma dataset (HCC dataset) 

* Clinical data of 165 pts with HCC (demographic, risk factors, lab data, and survival features)

* 49 features from HCC clinical practice guidelines (Table 1)

* About 80% male, 74% had alochol related liver disease, 27% had hepatitis B, 21 % had hepatitis C, and 90% had cirrhosis. 

* Missing data represents 10.22% of the whole dataset and only eight patients have complete information in all fields (4.85%). 

* The target variable is the survival at 1 year, coded as 0 (dies) and 1 (lives). 

# Random Forest Model

## Description

## Estimated Performance

## Calibration Plots

## Variable Importance

## Partial Dependence

# XGBoost Model

## Description

## Estimated Performance

## Calibration Plots

## Variable Importance

## Partial Dependence

# Support Vector Machine Model

## Description

```{r, cache = TRUE}
fit_jt <- readRDS("./data/ModelCache/knn_none_SVMRad_fit.RDS")
sfit <- summary(as.MLModel(fit_jt))
hyperparam <- Reduce(cbind, sfit$TrainingStep1$params[sfit$TrainingStep1$selected,])

```


* A support vector machine attempts to draw a non-linear boundary to classify the outcome by transforming the predictors using basis functions

* In this transformed space, find linear boundaries using support vector classifier.

* We just need to know the kernel function on the basis functions, don't need to know basis function itself. 

* Radial Basis kernel function: $\exp(-\sigma^2\Vert x - x' \Vert^2)$; $\sigma =$ `r hyperparam$sigma`

* Cost of misclassification C =`r hyperparam$C`

* imputation using knn with neighbors = 4


## Estimated Performance

```{r, cache = TRUE}
resamp_jt <- readRDS("./data/ModelCache/knn_none_SVMRad_res.RDS")
sres_jt <- as.data.frame(summary(resamp_jt))
as.data.frame(sres_jt) %>% 
  pivot_wider(names_from = Statistic, values_from = Value) %>%
  kable(caption = "SVMRad results with knn imputation",
        digits = 3) %>%
  kable_styling(full_width = FALSE)
```


## Calibration Plots

```{r out.height="70%", out.width="70%", fig.align='center', results='hide'}
plot(calibration(resamp_jt))
```

* Decently calibrated. Low probabilities have many false negatives.

## Variable Importance

```{r warning=FALSE, out.width="80%", out.height="80%", fig.align='center', cache = TRUE}
set.seed(123123)
if(file.exists("./vi_cache/knn_none_SVMRad_vi.RDS")){
  vi_jt <- readRDS("./vi_cache/knn_none_SVMRad_vi.RDS")
}else{
  vi_jt <- varimp(fit_jt)
  saveRDS(vi_jt, "./vi_cache/knn_none_SVMRad_vi.RDS")
}
plot(vi_jt, n=15)
```

## Variable Importance

\begin{itemize}
  \item { Symptoms (performance)}

  \item { Indicators of liver injury/disease/infection (hepBsurfAnti, hepCvirAnti,aspartateTransaminase, alkalinePhosphatase, ferritin, totalProteins, ascites, hemoglobin)}

  \item { Biological Characteristics (age, portalVeinThromb)}

  \item { Risk factors (diabetes, artHyper)}
  
  \item {behavioral/demographic (endemicCountries, cigPerYr)}
\end{itemize}


## Partial Dependence: diabetes

```{r results='hide'}
pd <- dependence(fit_jt, select = c(diabetes))
plot(pd)
```

## Partial Dependence: ferritin

```{r results='hide'}
pd <- dependence(fit_jt, select = c(ferritin))
plot(pd)
```


## Partial Dependence ascites

```{r results='hide'}
pd <- dependence(fit_jt, select = c(ascites))
plot(pd)
```

## Partial Dependence: artHyper

```{r results='hide'}
pd <- dependence(fit_jt, select = c(hepCvirAnti))
plot(pd)
```


## Partial Dependence: symptom

```{r, warning=FALSE, results='hide'}
pd <- dependence(fit_jt, select = c(artHyper))
plot(pd)
```

# Final Model

* Final model was chosen by the model with the highest Sensitivity - 2SD

# References {.allowframebreaks}